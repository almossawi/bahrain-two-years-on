"use strict";var LANG,default_opacity=0.7,fixed_card=true,default_stroke_width=1,trans_stroke_width=10,highlighted_stroke_width=4,death_count=0;var from_selected=-1,age_selected=-1,death_code_selected=-1;$(document).ready(function(){d3.json("lang/en_US.json",function(a){LANG=a;$("select, input, a.button, button").uniform();assignEventListeners();drawMainVisual("#tree");$("#age").val($("#age option:first").val());$("#death_code").val($("#death_code option:first").val());$("#from").val($("#from option:first").val());$.uniform.update();if(Function("/*@cc_on return document.documentMode===10@*/")()){document.documentElement.className+=" ie10"}})});function resetAllStrokes(){$("path.treebranch").attr("stroke-width",default_stroke_width).attr("opacity",default_opacity)}function assignMainVisualListeners(){$("#show_band_45yrs").toggle(function(){$("#band_45yrs").show()},function(){console.log("two");$("#band_45yrs").hide()});$("#show_band_90yrs").toggle(function(){$("#band_90yrs").show()},function(){console.log("two");$("#band_90yrs").hide()})}function assignEventListeners(){$("body").on("click",function(){$("#details").fadeOut();resetAllStrokes()});$("#fix_or_float").on("change",function(a){if(a.target.value=="fix"){fixed_card=true}else{if(a.target.value=="float"){fixed_card=false}}return false});$("#ages img").mouseenter(function(a){$("#ages_menu").show()});$("#ages img").mouseleave(function(a){$("#ages_menu").hide()});$("#ages_menu").mouseenter(function(a){$("#ages_menu").show()});$("#ages_menu").mouseleave(function(a){$("#ages_menu").hide()});$("#ages_menu ul li a").on("click",function(a){$("#ages_menu ul li a").css("font-weight","300");$(this).css("font-weight","600");$("#ages span").html($(this).html());age_selected=$(this).attr("code");$(".treebranch_transparent").attr("visibility","visible");resetAllStrokes();$("#details").hide();if($(this).attr("code")=="-1"){resetDropdownBox(age_selected);return false}handleDropdownBox();return false});$("#death_code img").mouseenter(function(a){$("#death_code_menu").show()});$("#death_code img").mouseleave(function(a){$("#death_code_menu").hide()});$("#death_code_menu").mouseenter(function(a){$("#death_code_menu").show()});$("#death_code_menu").mouseleave(function(a){$("#death_code_menu").hide()});$("#death_code_menu ul li a").on("click",function(a){$("#death_code_menu ul li a").css("font-weight","300");$(this).css("font-weight","600");$("#death_code span").html($(this).html());death_code_selected=$(this).attr("code");$(".treebranch_transparent").attr("visibility","visible");resetAllStrokes();$("#details").hide();if($(this).attr("code")=="-1"){resetDropdownBox(death_code_selected);return false}handleDropdownBox();return false});$("#from img").mouseenter(function(a){$("#from_menu").show()});$("#from img").mouseleave(function(a){$("#from_menu").hide()});$("#from_menu").mouseenter(function(a){$("#from_menu").show()});$("#from_menu").mouseleave(function(a){$("#from_menu").hide()});$("#from_menu ul li a").on("click",function(a){$("#from_menu ul li a").css("font-weight","300");$(this).css("font-weight","600");$("#from span").html($(this).html());from_selected=($(this).attr("code")=="-1")?$(this).attr("code"):$(this).html();$(".treebranch_transparent").attr("visibility","visible");resetAllStrokes();$("#details").hide();if($(this).attr("code")=="-1"){resetDropdownBox(from_selected);return false}handleDropdownBox();return false})}function resetDropdownBox(a){window.which_one=-1;var b=0;d3.selectAll(".treebranch").each(function(f,e){if((age_selected==-1||((f.age>60&&Number(age_selected)==60)||(f.age>=Number(age_selected)&&f.age<(Number(age_selected)+9))))&&(death_code_selected==-1||f.death_code==death_code_selected)&&(from_selected==-1||f.from==from_selected)){$(this).attr("class","treebranch").css("opacity",default_opacity);b++}else{$("#transp"+f.id).attr("visibility","hidden")}});var c=(b==1)?"LIFE":"LIVES";$("#count").html(b+" "+c)}function handleDropdownBox(){var a=0;d3.selectAll(".treebranch").each(function(e,c){if((age_selected==-1||((e.age>60&&Number(age_selected)==60)||(e.age>=Number(age_selected)&&e.age<(Number(age_selected)+9))))&&(death_code_selected==-1||e.death_code==death_code_selected)&&(from_selected==-1||e.from==from_selected)){$("#p"+e.id).delay(500).attr("class","treebranch").css("opacity",default_opacity);a++}else{$("#p"+e.id).attr("class","treebranch off").css("opacity",0.1);$("#transp"+e.id).attr("visibility","hidden")}});var b=(a==1)?"LIFE":"LIVES";$("#count").html(a+" "+b);return false}function drawTimeSeries(y,j,n,q,v,d){var s=new Object();$.each(y.deaths,function(h,w){if(s[w.date_of_death]==undefined){s[w.date_of_death]={date:0,count:0};s[w.date_of_death].date=+new Date(w.date_of_death);s[w.date_of_death].count=1}else{s[w.date_of_death].count=s[w.date_of_death].count+1}});y=s;var i=950,o=200,k=22,c=30,m="%b %e, %Y";j+=" div";var t=j;d3.entries(y).sort(function(w,h){return w.date-h.date});var r=+new Date("2011-01-01"),u=+new Date("2013-02-14"),b=0,e=d3.max(d3.values(y),function(h){return h.count});e+=1;var z=d3.time.scale().domain([r,u]).range([k+16,i-k]);var f=d3.scale.linear().domain([b,e]).range([o-c+2,c-6]);var g=d3.svg.axis().scale(z).orient("bottom").tickFormat(d3.time.format(m)).ticks(10);var a=d3.svg.axis().scale(f).orient("left").tickFormat(d3.format(n)).ticks(5);var l=d3.select(j).append("svg").attr("width",i).attr("height",o);var x=l.selectAll(".ticky").data(f.ticks(5)).enter().append("svg:g").attr("transform",function(h){return"translate(0, "+(f(h)+1)+")"}).attr("class","ticky").append("svg:line").attr("y1",-1).attr("y2",-1).attr("x1",c+5).attr("x2",i-c+8);var g=l.append("g").attr("class","axis x").attr("transform","translate(2,"+(o-k-6)+")").call(g);l.append("g").attr("class","axis y").attr("transform","translate("+(c+10)+",0)").call(a);x=l.selectAll(".tickx").data(z.ticks(9)).enter().append("svg:g").attr("transform",function(w,h){return"translate("+(z(w)-26)+", 0)"}).attr("class","tickx");x.append("svg:line").attr("y1",o-k).attr("y2",k).attr("x1",0).attr("x2",0);var p=l.selectAll("rect").data(d3.entries(y)).enter().append("rect").attr("class","bar").attr("opacity",1).attr("fill",function(h){return"#fff"}).attr("x",function(w,h){return z(w.value.date)-3}).attr("y",function(h){return o-c-1}).attr("height",function(h){return 0}).attr("opacity",0.8).attr("width",1).each(function(A,w){var h=Date.parse(A.key).toString("yyyy")+"-"+Date.parse(A.key).toString("MM")+"-"+Date.parse(A.key).toString("dd");if("undefined"!=typeof d[h]){d3.select(t+" svg").append("svg:line").attr("class","annotation_line").attr("stroke-dasharray","1,3").attr("y1",7).attr("y2",36).attr("x1",z(A.value.date)-1).attr("x2",z(A.value.date)-1);d3.select(t+" svg").append("svg:text").attr("class","annotation_text").text(d[h].annotation).attr("y",17).attr("x",z(A.value.date)+4);d3.select(t+" svg").append("svg:text").attr("class","annotation_text").text(d[h].annotation_line2).attr("y",31).attr("x",z(A.value.date)+4)}}).on("mouseover.tooltip",function(w){var h=w;w=w.value;d3.select(".tooltip_box").remove();d3.selectAll(".tooltip").remove();d3.select(t+" svg").append("svg:rect").attr("width",15).attr("height",16).attr("x",z(w.date)-10).attr("y",function(){return f(w.count)-24}).attr("class","tooltip_box");d3.select(t+" svg").append("text").text(function(){var A=Date.parse(h.key).toString("MMMM dd, yyyy");$("#full_date").html(A).fadeIn();return w.count}).attr("x",function(){return z(w.date)-2}).attr("y",function(){return f(w.count)-11}).style("cursor","default").attr("dy","0.35m").attr("text-anchor","middle").attr("class","tooltip")}).transition().duration(1000).attr("y",function(h){return f(h.value.count)-1}).attr("height",function(h){return(o-c)-f(h.value.count)})}function drawMainVisual(a){d3.json("data/feb2013.json",function(b){d3.json("data/annotations.json",function(f){death_count=b.deaths.length;var r="s",t=false,u="";drawTimeSeries(b,"#time_series",r,t,u,f);var m=1100,s=600,n=0,e=10,p="%b %e",j=d3.max(b.deaths,function(h){return h.age});var i=455,g=480,d=-400,c=-425,l=3;var k=d3.scale.linear().domain([0,j]).range([-30,-450]);var o=d3.select(a).append("svg").attr("width",m).attr("height",s);o.append("svg:line").attr("id","yaxis").attr("stroke","#cccccc").attr("stroke-width","1").attr("x1",20).attr("y1",10).attr("y2",460).attr("x2",20);o.append("svg:text").attr("id","ali").style("fill","#cccccc").attr("x",13).attr("y",20).style("font-size","10px").attr("transform","rotate(-90, 10 , 20) translate(-240, 0)").text("Victim's age");o.append("svg:text").style("fill","#cccccc").attr("x",26).attr("y",20).style("font-size","10px").attr("id","show_band_90yrs").text("90 years");o.append("svg:rect").attr("fill","#7b7b7b").attr("opacity","0.1").attr("id","band_90yrs").style("display","none").attr("x",18).attr("y",20).attr("height",215).attr("width",1150);o.append("svg:text").style("fill","#cccccc").attr("x",26).attr("y",235).attr("id","show_band_45yrs").style("font-size","10px").text("45 years");o.append("svg:rect").attr("fill","#7b7b7b").attr("opacity","0.1").attr("id","band_45yrs").style("display","none").attr("x",18).attr("y",235).attr("height",215).attr("width",1150);o.append("svg:text").style("fill","#cccccc").attr("x",26).attr("y",458).style("font-size","10px").text("Newborn");var q=0;o.selectAll("path").data(b.deaths).enter().append("svg:path").attr("opacity",function(){return default_opacity}).attr("id",function(h){return"p"+h.id}).attr("stroke-width",default_stroke_width).attr("stroke","cyan").attr("class","treebranch").attr("d",function(h){return"m "+i+","+(g+200)+" L "+i+","+g+" c 0,0 0,0 0,0"}).attr("d",function(w){var h=(w.id%2==1&&w.id!=1)?d:d*-1;var v=i+q;q=q+2;return"m "+v+","+(g+200)+" L "+v+","+g+" c "+l+","+k(w.age)+" "+h+","+k(w.age)+" "+h+","+k(w.age)}).attr("stroke",function(v){var h=d3.scale.linear().domain([0,j]).range(["#e33258","cyan"]);return h(v.age)}).each(function(v,h){o.append("svg:path").attr("shape-rendering","crispEdges").style("opacity","0").attr("id",function(){return"transp"+v.id}).attr("stroke-width",trans_stroke_width).attr("stroke","white").attr("class","treebranch_transparent").attr("d",function(){return $("#p"+v.id).attr("d");return"m "+i+","+(g+200)+" L "+i+","+g+" c 0,0 0,0 0,0"}).on("mouseover",function(){if($("#p"+v.id).attr("class")=="treebranch off"){return false}resetAllStrokes();$("#p"+v.id).attr("stroke-width",highlighted_stroke_width).attr("opacity",1);var w=(v.age<1)?v.actual_age:v.age+" years";var x="<span style='font-weight:bold;font-size:15px'>"+v.name+"</span><br />"+w+", from "+v.from+"<br />Killed "+Date.parse(v.date_of_death).toString("dddd, MMM d, yyyy")+"<br /><p>&ldquo;"+v.type_of_death_full+"&rdquo;</p>";if(fixed_card){$("#details").css("top",function(){return"100px"}).css("margin-left",function(){return"990px"})}else{$("#details").css("top",function(){return g+k(v.age)}).css("margin-left",function(){if(v.id==1){return"990px"}else{if(v.id%2==1){return"-160px"}else{return"990px"}}})}$("#details").fadeIn().html(x)})});$("#count").html(b.deaths.length+" LIVES");assignMainVisualListeners()})})}function addCommas(e){e+="";var a=e.split(".");var d=a[0];var b=a.length>1?"."+a[1]:"";var c=/(\d+)(\d{3})/;while(c.test(d)){d=d.replace(c,"$1,$2")}return d+b}function getHumanSize(b){var a=" kmbtpezyxwvu";if(b<=0){return"0"}var c=Math.min(Math.floor(Math.log(b)/Math.log(1000)),12);return(Math.round(b*100/Math.pow(1000,c))/100)+a.charAt(c).replace(" ","")}function isNumber(a){return !isNaN(parseFloat(a))&&isFinite(a)}function getRandomInt(b,a){return Math.floor(Math.random()*(a-b+1))+b}Array.prototype.shuffle=function(){for(var c=this.length-1;c>0;c--){var a=Math.floor(Math.random()*(c+1));var b=this[c];this[c]=this[a];this[a]=b}return this};