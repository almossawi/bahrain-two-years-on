"use strict";function resetAllStrokes(){$("path.treebranch").attr("stroke-width",default_stroke_width).attr("opacity",default_opacity)}function assignMainVisualListeners(){$("#show_band_45yrs").toggle(function(){$("#band_45yrs").show()},function(){console.log("two");$("#band_45yrs").hide()});$("#show_band_90yrs").toggle(function(){$("#band_90yrs").show()},function(){console.log("two");$("#band_90yrs").hide()})}function assignEventListeners(){$("body").on("click",function(){$("#details").fadeOut();resetAllStrokes()});$("#fix_or_float").on("change",function(e){if(e.target.value=="fix"){fixed_card=true}else if(e.target.value=="float"){fixed_card=false}return false});$("#ages img").mouseenter(function(e){$("#ages_menu").show()});$("#ages img").mouseleave(function(e){$("#ages_menu").hide()});$("#ages_menu").mouseenter(function(e){$("#ages_menu").show()});$("#ages_menu").mouseleave(function(e){$("#ages_menu").hide()});$("#ages_menu ul li a").on("click",function(e){$("#ages_menu ul li a").css("font-weight","300");$(this).css("font-weight","600");$("#ages span").html($(this).html());age_selected=$(this).attr("code");$(".treebranch_transparent").attr("visibility","visible");resetAllStrokes();$("#details").hide();if($(this).attr("code")=="-1"){resetDropdownBox(age_selected);return false}handleDropdownBox();return false});$("#death_code img").mouseenter(function(e){$("#death_code_menu").show()});$("#death_code img").mouseleave(function(e){$("#death_code_menu").hide()});$("#death_code_menu").mouseenter(function(e){$("#death_code_menu").show()});$("#death_code_menu").mouseleave(function(e){$("#death_code_menu").hide()});$("#death_code_menu ul li a").on("click",function(e){$("#death_code_menu ul li a").css("font-weight","300");$(this).css("font-weight","600");$("#death_code span").html($(this).html());death_code_selected=$(this).attr("code");$(".treebranch_transparent").attr("visibility","visible");resetAllStrokes();$("#details").hide();if($(this).attr("code")=="-1"){resetDropdownBox(death_code_selected);return false}handleDropdownBox();return false});$("#from img").mouseenter(function(e){$("#from_menu").show()});$("#from img").mouseleave(function(e){$("#from_menu").hide()});$("#from_menu").mouseenter(function(e){$("#from_menu").show()});$("#from_menu").mouseleave(function(e){$("#from_menu").hide()});$("#from_menu ul li a").on("click",function(e){$("#from_menu ul li a").css("font-weight","300");$(this).css("font-weight","600");$("#from span").html($(this).html());from_selected=$(this).attr("code")=="-1"?$(this).attr("code"):$(this).html();$(".treebranch_transparent").attr("visibility","visible");resetAllStrokes();$("#details").hide();if($(this).attr("code")=="-1"){resetDropdownBox(from_selected);return false}handleDropdownBox();return false})}function resetDropdownBox(e){window.which_one=-1;var t=0;d3.selectAll(".treebranch").each(function(e,n){if((age_selected==-1||e.age>60&&Number(age_selected)==60||e.age>=Number(age_selected)&&e.age<Number(age_selected)+9)&&(death_code_selected==-1||e.death_code==death_code_selected)&&(from_selected==-1||e.from==from_selected)){$(this).attr("class","treebranch").css("opacity",default_opacity);t++}else{$("#transp"+e.id).attr("visibility","hidden")}});var n=t==1?"LIFE":"LIVES";$("#count").html(t+" "+n)}function handleDropdownBox(){var e=0;d3.selectAll(".treebranch").each(function(t,n){if((age_selected==-1||t.age>60&&Number(age_selected)==60||t.age>=Number(age_selected)&&t.age<Number(age_selected)+9)&&(death_code_selected==-1||t.death_code==death_code_selected)&&(from_selected==-1||t.from==from_selected)){$("#p"+t.id).delay(500).attr("class","treebranch").css("opacity",default_opacity);e++}else{$("#p"+t.id).attr("class","treebranch off").css("opacity",.1);$("#transp"+t.id).attr("visibility","hidden")}});var t=e==1?"LIFE":"LIVES";$("#count").html(e+" "+t);return false}function drawTimeSeries(e,t,n,r,i,s){var o=new Object;$.each(e.deaths,function(e,t){if(o[t.date_of_death]==undefined){o[t.date_of_death]={date:0,count:0};o[t.date_of_death].date=+(new Date(t.date_of_death));o[t.date_of_death].count=1}else{o[t.date_of_death].count=o[t.date_of_death].count+1}});e=o;var u=950,a=200,f=22,l=30,c="%b %e, %Y";t+=" div";var h=t;d3.entries(e).sort(function(e,t){return e.date-t.date});var p=+(new Date("2011-01-01")),d=+(new Date("2013-02-28")),v=0,m=d3.max(d3.values(e),function(e){return e.count});m+=1;var g=d3.time.scale().domain([p,d]).range([f+16,u-f]);var y=d3.scale.linear().domain([v,m]).range([a-l+2,l-6]);var b=d3.svg.axis().scale(g).orient("bottom").tickFormat(d3.time.format(c)).ticks(10);var w=d3.svg.axis().scale(y).orient("left").tickFormat(d3.format(n)).ticks(5);var E=d3.select(t).append("svg").attr("width",u).attr("height",a);var S=E.selectAll(".ticky").data(y.ticks(5)).enter().append("svg:g").attr("transform",function(e){return"translate(0, "+(y(e)+1)+")"}).attr("class","ticky").append("svg:line").attr("y1",-1).attr("y2",-1).attr("x1",l+5).attr("x2",u-l+8);var b=E.append("g").attr("class","axis x").attr("transform","translate(2,"+(a-f-6)+")").call(b);E.append("g").attr("class","axis y").attr("transform","translate("+(l+10)+",0)").call(w);S=E.selectAll(".tickx").data(g.ticks(9)).enter().append("svg:g").attr("transform",function(e,t){return"translate("+(g(e)-26)+", 0)"}).attr("class","tickx");S.append("svg:line").attr("y1",a-f).attr("y2",f).attr("x1",0).attr("x2",0);var x=E.selectAll("rect").data(d3.entries(e)).enter().append("rect").attr("class","bar").attr("opacity",1).attr("fill",function(e){return"#fff"}).attr("x",function(e,t){return g(e.value.date)-3}).attr("opacity",.8).attr("width",1).attr("y",function(e){return y(e.value.count)-1}).attr("height",function(e){console.log(a-l-y(e.value.count));return a-l-y(e.value.count)}).each(function(e,t){var n=Date.parse(e.key).toString("yyyy")+"-"+Date.parse(e.key).toString("MM")+"-"+Date.parse(e.key).toString("dd");if("undefined"!=typeof s[n]){d3.select(h+" svg").append("svg:line").attr("class","annotation_line").attr("stroke-dasharray","1,3").attr("y1",7).attr("y2",36).attr("x1",g(e.value.date)-1).attr("x2",g(e.value.date)-1);d3.select(h+" svg").append("svg:text").attr("class","annotation_text").text(s[n].annotation).attr("y",17).attr("x",g(e.value.date)+4);d3.select(h+" svg").append("svg:text").attr("class","annotation_text").text(s[n].annotation_line2).attr("y",31).attr("x",g(e.value.date)+4)}}).on("mouseover.tooltip",function(e){var t=e;e=e.value;d3.select(".tooltip_box").remove();d3.selectAll(".tooltip").remove();d3.select(h+" svg").append("svg:rect").attr("width",15).attr("height",16).attr("x",g(e.date)-10).attr("y",function(){return y(e.count)-24}).attr("class","tooltip_box");d3.select(h+" svg").append("text").text(function(){var n=Date.parse(t.key).toString("MMMM dd, yyyy");$("#full_date").html(n).fadeIn();return e.count}).attr("x",function(){return g(e.date)-2}).attr("y",function(){return y(e.count)-11}).style("cursor","default").attr("dy","0.35m").attr("text-anchor","middle").attr("class","tooltip")})}function drawMainVisual(e){d3.json("data/feb2013.json",function(t){d3.json("data/annotations.json",function(n){death_count=t.deaths.length;var r="s",i=false,s="";drawTimeSeries(t,"#time_series",r,i,s,n);var o=1100,u=600,a=0,f=10,l="%b %e",c=d3.max(t.deaths,function(e){return e.age});var h=455,p=480,d=-400,v=-425,m=3;var g=d3.scale.linear().domain([0,c]).range([-30,-450]);var y=d3.select(e).append("svg").attr("width",o).attr("height",u);y.append("svg:line").attr("id","yaxis").attr("stroke","#cccccc").attr("stroke-width","1").attr("x1",20).attr("y1",10).attr("y2",460).attr("x2",20);y.append("svg:text").attr("id","ali").style("fill","#cccccc").attr("x",13).attr("y",20).style("font-size","10px").attr("transform","rotate(-90, 10 , 20) translate(-240, 0)").text("Victim's age");y.append("svg:text").style("fill","#cccccc").attr("x",26).attr("y",20).style("font-size","10px").attr("id","show_band_90yrs").text("90 years");y.append("svg:rect").attr("fill","#7b7b7b").attr("opacity","0.1").attr("id","band_90yrs").style("display","none").attr("x",18).attr("y",20).attr("height",215).attr("width",1150);y.append("svg:text").style("fill","#cccccc").attr("x",26).attr("y",235).attr("id","show_band_45yrs").style("font-size","10px").text("45 years");y.append("svg:rect").attr("fill","#7b7b7b").attr("opacity","0.1").attr("id","band_45yrs").style("display","none").attr("x",18).attr("y",235).attr("height",215).attr("width",1150);y.append("svg:text").style("fill","#cccccc").attr("x",26).attr("y",458).style("font-size","10px").text("Newborn");var b=0;y.selectAll("path").data(t.deaths).enter().append("svg:path").attr("opacity",function(){return default_opacity}).attr("id",function(e){return"p"+e.id}).attr("stroke-width",default_stroke_width).attr("stroke","cyan").attr("class","treebranch").attr("d",function(e){return"m "+h+","+(p+200)+" L "+h+","+p+" c 0,0 0,0 0,0"}).attr("d",function(e){var t=e.id%2==1&&e.id!=1?d:d*-1;var n=h+b;b=b+2;return"m "+n+","+(p+200)+" L "+n+","+p+" c "+m+","+g(e.age)+" "+t+","+g(e.age)+" "+t+","+g(e.age)}).attr("stroke",function(e){var t=d3.scale.linear().domain([0,c]).range(["#e33258","cyan"]);return t(e.age)}).each(function(e,t){y.append("svg:path").attr("shape-rendering","crispEdges").style("opacity","0").attr("id",function(){return"transp"+e.id}).attr("stroke-width",trans_stroke_width).attr("stroke","white").attr("class","treebranch_transparent").attr("d",function(){return $("#p"+e.id).attr("d");return"m "+h+","+(p+200)+" L "+h+","+p+" c 0,0 0,0 0,0"}).on("mouseover",function(){if($("#p"+e.id).attr("class")=="treebranch off"){return false}resetAllStrokes();$("#p"+e.id).attr("stroke-width",highlighted_stroke_width).attr("opacity",1);var t=e.age<1?e.actual_age:e.age+" years";var n="<span style='font-weight:bold;font-size:15px'>"+e.name+"</span><br />"+t+", from "+e.from+"<br />"+"Killed "+Date.parse(e.date_of_death).toString("dddd, MMM d, yyyy")+"<br />"+"<p>“"+e.type_of_death_full+"”</p>";if(fixed_card){$("#details").css("top",function(){return"100px"}).css("margin-left",function(){return"990px"})}else{$("#details").css("top",function(){return p+g(e.age)}).css("margin-left",function(){if(e.id==1)return"990px";else if(e.id%2==1)return"-160px";else return"990px"})}$("#details").fadeIn().html(n)})});$("#count").html(t.deaths.length+" LIVES");assignMainVisualListeners()})})}function addCommas(e){e+="";var t=e.split(".");var n=t[0];var r=t.length>1?"."+t[1]:"";var i=/(\d+)(\d{3})/;while(i.test(n)){n=n.replace(i,"$1"+","+"$2")}return n+r}function getHumanSize(e){var t=" kmbtpezyxwvu";if(e<=0)return"0";var n=Math.min(Math.floor(Math.log(e)/Math.log(1e3)),12);return Math.round(e*100/Math.pow(1e3,n))/100+t.charAt(n).replace(" ","")}function isNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}var LANG,default_opacity=.7,fixed_card=true,default_stroke_width=1,trans_stroke_width=10,highlighted_stroke_width=4,death_count=0;var from_selected=-1,age_selected=-1,death_code_selected=-1;$(document).ready(function(){d3.json("lang/en_US.json",function(e){LANG=e;$("select, input, a.button, button").uniform();assignEventListeners();drawMainVisual("#tree");$("#age").val($("#age option:first").val());$("#death_code").val($("#death_code option:first").val());$("#from").val($("#from option:first").val());$.uniform.update();if(Function("/*@cc_on return document.documentMode===10@*/")()){document.documentElement.className+=" ie10"}})});Array.prototype.shuffle=function(){for(var e=this.length-1;e>0;e--){var t=Math.floor(Math.random()*(e+1));var n=this[e];this[e]=this[t];this[t]=n}return this}